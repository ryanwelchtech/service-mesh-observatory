name: CD

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    environment:
      name: staging
      url: https://staging.observatory.example.com

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'

    - name: Set up kubeconfig
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBECONFIG_STAGING }}" | base64 -d > $HOME/.kube/config
        chmod 600 $HOME/.kube/config

    - name: Update image tags
      run: |
        cd infrastructure/kubernetes/overlays/staging
        kustomize edit set image \
          ghcr.io/${{ github.repository }}/observatory-backend:${{ github.sha }} \
          ghcr.io/${{ github.repository }}/observatory-frontend:${{ github.sha }}

    - name: Deploy to Kubernetes
      run: |
        kubectl apply -k infrastructure/kubernetes/overlays/staging

    - name: Verify deployment
      run: |
        kubectl rollout status deployment/observatory-backend -n observatory --timeout=5m
        kubectl rollout status deployment/observatory-frontend -n observatory --timeout=5m

    - name: Run smoke tests
      run: |
        BACKEND_URL=$(kubectl get svc observatory-backend -n observatory -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        curl -f http://${BACKEND_URL}:8000/health || exit 1
        curl -f http://${BACKEND_URL}:8000/ready || exit 1

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    environment:
      name: production
      url: https://observatory.example.com

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract version
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Configure kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'

    - name: Set up kubeconfig
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBECONFIG_PRODUCTION }}" | base64 -d > $HOME/.kube/config
        chmod 600 $HOME/.kube/config

    - name: Update image tags
      run: |
        cd infrastructure/kubernetes/overlays/production
        kustomize edit set image \
          ghcr.io/${{ github.repository }}/observatory-backend:${{ steps.version.outputs.VERSION }} \
          ghcr.io/${{ github.repository }}/observatory-frontend:${{ steps.version.outputs.VERSION }}

    - name: Deploy to Kubernetes
      run: |
        kubectl apply -k infrastructure/kubernetes/overlays/production

    - name: Verify deployment
      run: |
        kubectl rollout status deployment/observatory-backend -n observatory --timeout=10m
        kubectl rollout status deployment/observatory-frontend -n observatory --timeout=10m

    - name: Run smoke tests
      run: |
        BACKEND_URL=$(kubectl get svc observatory-backend -n observatory -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        curl -f http://${BACKEND_URL}:8000/health || exit 1
        curl -f http://${BACKEND_URL}:8000/ready || exit 1

    - name: Notify deployment success
      if: success()
      run: |
        echo "Production deployment successful: ${{ steps.version.outputs.VERSION }}"

    - name: Rollback on failure
      if: failure()
      run: |
        kubectl rollout undo deployment/observatory-backend -n observatory
        kubectl rollout undo deployment/observatory-frontend -n observatory
        exit 1
